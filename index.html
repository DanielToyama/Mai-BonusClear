<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mai存档集章卡一键盖满工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-top: 0;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            min-width: 150px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
        }

        .file-input {
            margin: 20px 0;
        }

        .alert strong {
            font-weight: bold;
        }

        .alert strong {
            font-weight: bold;
        }

        .alert {
            background-color: #ffcc00;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alertred {
            background-color: #e1504860;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .version-selector {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
        }

        select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Mai存档集章卡一键盖满工具</h1>
        <div class="alert">
            <strong>注意：</strong>这是一个 Beta 版本的页面，转换过程中请一定一定确保备份当前存档。遇到问题请及时反馈。<a href="https://DanielToyama.fun"
                target="_blank" style="text-decoration: none; color: #6f00004c;">联系户山兔兔</a>
        </div>
        <p>上传私服存档JSON文件，自动修改存档盖章数据</p>
        <p>特别感谢由<a href="https://space.bilibili.com/326501940" target="_blank"
                style="text-decoration: none; color: #2161d6;">@格瓦拉</a>提供的数据和思路</p>

        <div class="version-selector">
            <label for="versionSelect">选择游戏版本：</label>
            <select id="versionSelect">
                <option value="156">版本 156</option>
                <option value="160">版本 160初日</option>
            </select>
        </div>
        <div class="alertred">
            <strong>小心：</strong>提前获得比当前游玩版本新的集章卡物品可能导致异常的问题，请谨慎选择
        </div>
        <div class="file-input">
            <input type="file" id="jsonFile" accept=".json" style="display: none;">
            <button id="selectFileBtn" class="btn">选择JSON文件</button>
            <div id="fileName"></div>
        </div>

        <div id="status" class="status"></div>

        <button id="processBtn" class="btn" disabled>处理并下载</button>
        <p>
            <a href="https://github.com/DanielToyama/Mai-BonusClear" target="_blank"
                style="text-decoration: none; color: #000000;">GitHub</a>
        </p>
        <a href="https://DanielToyama.fun" target="_blank" style="text-decoration: none; color: #ef5ff9;">联系户山兔兔</a>
    </div>

    <script>
        // 版本数据缓存
        const versionDataCache = {};
        
        // 当前选中的数据
        let currentTable1 = [];
        let currentFixedUserLoginBonusList = [];

        // DOM元素
        const jsonFileInput = document.getElementById('jsonFile');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const processBtn = document.getElementById('processBtn');
        const statusDiv = document.getElementById('status');
        const fileNameDiv = document.getElementById('fileName');
        const versionSelect = document.getElementById('versionSelect');

        // 加载版本数据
        async function loadVersionData(version) {
            if (versionDataCache[version]) {
                return versionDataCache[version];
            }

            try {
                const response = await fetch(`version_${version}.json`);
                if (!response.ok) {
                    throw new Error(`无法加载版本 ${version} 的数据`);
                }
                const data = await response.json();
                versionDataCache[version] = {
                    table1: data.table1 || [],
                    fixedUserLoginBonusList: data.fixedUserLoginBonusList || []
                };
                return versionDataCache[version];
            } catch (error) {
                showStatus(`加载版本数据失败: ${error.message}`, "error");
                throw error;
            }
        }

        // 版本选择变化事件
        versionSelect.addEventListener('change', async function() {
            const version = this.value;
            try {
                showStatus(`正在加载版本 ${version} 的数据...`, "success");
                const data = await loadVersionData(version);
                currentTable1 = data.table1;
                currentFixedUserLoginBonusList = data.fixedUserLoginBonusList;
                showStatus(`版本 ${version} 数据已加载`, "success");
            } catch (error) {
                console.error(error);
            }
        });

        // 点击选择文件按钮触发文件输入
        selectFileBtn.addEventListener('click', function () {
            jsonFileInput.click();
        });

        // 文件上传处理
        jsonFileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            fileNameDiv.textContent = `已选择: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    JSON.parse(e.target.result); // 仅验证，不存储
                    showStatus("文件已加载，点击处理按钮继续", "success");
                    processBtn.disabled = false;
                } catch (error) {
                    showStatus(`JSON解析错误: ${error.message}`, "error");
                    processBtn.disabled = true;
                }
            };
            reader.onerror = function () {
                showStatus("文件读取失败", "error");
                processBtn.disabled = true;
            };
            reader.readAsText(file);
        });

        // 显示状态信息
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = "block";
        }

        // 核心处理函数
        function processData() {
            const file = jsonFileInput.files[0];
            if (!file) {
                showStatus("请先选择文件", "error");
                return null;
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const table2 = JSON.parse(e.target.result);

                        // 1. 处理userItemList
                        const table2Items = table2.userItemList || [];

                        // 创建新列表：当前版本项目 + 表二中不重复的项目
                        const newItemList = [
                            ...currentTable1, // 当前版本项目优先
                            ...table2Items.filter(item2 =>
                                !currentTable1.some(item1 =>
                                    item1.itemKind === item2.itemKind &&
                                    item1.itemId === item2.itemId
                                )
                            )
                        ];

                        // 2. 替换userLoginBonusList
                        const result = {
                            ...table2,
                            userItemList: newItemList,
                            userLoginBonusList: currentFixedUserLoginBonusList
                        };

                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsText(file);
            });
        }

        // 处理并下载按钮点击事件
        processBtn.addEventListener('click', async function () {
            try {
                showStatus("正在处理数据...", "success");

                const result = await processData();
                downloadFile(JSON.stringify(result, null, 2), 'processed_data.json');

                showStatus("处理完成，下载已开始", "success");
            } catch (error) {
                showStatus(`处理失败: ${error.message}`, "error");
                console.error(error);
            }
        });

        // 可靠的下载函数
        function downloadFile(content, filename) {
            try {
                const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';

                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                throw new Error(`下载失败: ${error.message}`);
            }
        }

        // 初始化：加载默认版本数据
        (async function init() {
            try {
                const defaultVersion = versionSelect.value;
                const data = await loadVersionData(defaultVersion);
                currentTable1 = data.table1;    
                currentFixedUserLoginBonusList = data.fixedUserLoginBonusList;
                showStatus(`版本 ${defaultVersion} 数据已加载`, "success");
            } catch (error) {
                console.error("初始化失败:", error);
            }
        })();
    </script>
</body>
</html>